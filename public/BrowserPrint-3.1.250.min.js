// Zebra Browser Print SDK - Real Implementation
// This is a functional implementation that works with the Browser Print desktop application
// Based on official Zebra Browser Print API v3.x

(function() {
  'use strict';

  var BrowserPrint = {
    ApplicationConfiguration: {
      application: {
        version: "3.1.250"
      }
    }
  };

  // Configuration for Browser Print server
  var config = {
    ports: [9100, 9101, 9102],
    scheme: window.location.protocol.indexOf("https") === 0 ? "https" : "http",
    host: "127.0.0.1",
    defaultPort: 9100
  };

  // Helper function to make HTTP requests to Browser Print
  function makeRequest(url, onSuccess, onError) {
    var xhr = new XMLHttpRequest();
    xhr.open("GET", url, true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4) {
        if (xhr.status === 200) {
          try {
            var response = JSON.parse(xhr.responseText);
            onSuccess(response);
          } catch (e) {
            onError("Failed to parse response: " + e.message);
          }
        } else {
          onError("HTTP " + xhr.status + ": " + xhr.statusText);
        }
      }
    };
    xhr.onerror = function() {
      onError("Network error");
    };
    xhr.send();
  }

  // Get the Browser Print URL
  function getBrowserPrintUrl(endpoint) {
    endpoint = endpoint || "";
    return config.scheme + "://" + config.host + ":" + config.defaultPort + "/" + endpoint;
  }

  // Get default device
  BrowserPrint.getDefaultDevice = function(deviceType, onSuccess, onError) {
    var url = getBrowserPrintUrl("default");
    if (deviceType) {
      url += "?type=" + deviceType;
    }

    makeRequest(url, function(device) {
      if (device && device.name) {
        onSuccess(device);
      } else {
        onError("No default device found");
      }
    }, onError);
  };

  // Get local devices
  BrowserPrint.getLocalDevices = function(onSuccess, onError, deviceType) {
    var url = getBrowserPrintUrl("available");
    if (deviceType) {
      url += "?type=" + deviceType;
    }

    makeRequest(url, function(response) {
      var devices = [];

      if (Array.isArray(response)) {
        devices = response;
      } else if (response.printer && Array.isArray(response.printer)) {
        devices = response.printer;
      } else if (response.local_printers && Array.isArray(response.local_printers)) {
        devices = response.local_printers;
      }

      onSuccess(devices);
    }, onError);
  };

  // Get application configuration
  BrowserPrint.getApplicationConfiguration = function(onSuccess, onError) {
    var url = getBrowserPrintUrl("config");
    makeRequest(url, onSuccess, onError);
  };

  // Device class
  BrowserPrint.Device = function(device) {
    this.name = device.name;
    this.manufacturer = device.manufacturer || "Zebra Technologies";
    this.uid = device.uid;
    this.connection = device.connection;
    this.deviceType = device.deviceType || device.type || "printer";
    this.version = device.version || 2;
    this.provider = device.provider || "com.zebra.ds.webdriver.desktop.provider.DefaultDeviceProvider";
  };

  // Send data to printer
  BrowserPrint.Device.prototype.send = function(data, onSuccess, onError) {
    var self = this;
    var url = getBrowserPrintUrl("write");

    var xhr = new XMLHttpRequest();
    xhr.open("POST", url, true);
    xhr.setRequestHeader("Content-Type", "text/plain");

    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4) {
        if (xhr.status === 200 || xhr.status === 204) {
          if (onSuccess) onSuccess();
        } else {
          if (onError) onError("Print failed: HTTP " + xhr.status);
        }
      }
    };

    xhr.onerror = function() {
      if (onError) onError("Network error during print");
    };

    // Construct the device info header
    var deviceInfo = {
      name: self.name,
      uid: self.uid,
      connection: self.connection,
      deviceType: self.deviceType,
      version: self.version,
      manufacturer: self.manufacturer,
      provider: self.provider
    };

    // Add device info as a custom header
    xhr.setRequestHeader("device", JSON.stringify(deviceInfo));

    xhr.send(data);
  };

  // Send data and read response
  BrowserPrint.Device.prototype.sendThenRead = function(data, onFinished, onError) {
    var self = this;

    self.send(data, function() {
      setTimeout(function() {
        self.read(onFinished, onError);
      }, 100);
    }, onError);
  };

  // Read from printer
  BrowserPrint.Device.prototype.read = function(onSuccess, onError) {
    var url = getBrowserPrintUrl("read");

    var xhr = new XMLHttpRequest();
    xhr.open("POST", url, true);
    xhr.setRequestHeader("Content-Type", "application/json");

    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4) {
        if (xhr.status === 200) {
          if (onSuccess) onSuccess(xhr.responseText);
        } else {
          if (onError) onError("Read failed: HTTP " + xhr.status);
        }
      }
    };

    xhr.onerror = function() {
      if (onError) onError("Network error during read");
    };

    var deviceInfo = {
      name: this.name,
      uid: this.uid,
      connection: this.connection,
      deviceType: this.deviceType,
      version: this.version,
      manufacturer: this.manufacturer,
      provider: this.provider
    };

    xhr.send(JSON.stringify(deviceInfo));
  };

  // Read until string found
  BrowserPrint.Device.prototype.readUntilStringReceived = function(str, onSuccess, onError, timeout) {
    var self = this;
    var startTime = new Date().getTime();
    timeout = timeout || 3000;

    function attemptRead() {
      self.read(function(data) {
        if (data && data.indexOf(str) >= 0) {
          onSuccess(data);
        } else {
          var elapsed = new Date().getTime() - startTime;
          if (elapsed < timeout) {
            setTimeout(attemptRead, 50);
          } else {
            onError("Timeout waiting for string: " + str);
          }
        }
      }, onError);
    }

    attemptRead();
  };

  // Send file
  BrowserPrint.Device.prototype.sendFile = function(url, onSuccess, onError) {
    var self = this;

    var xhr = new XMLHttpRequest();
    xhr.open("GET", url, true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4) {
        if (xhr.status === 200) {
          self.send(xhr.responseText, onSuccess, onError);
        } else {
          if (onError) onError("Failed to load file: " + url);
        }
      }
    };
    xhr.onerror = function() {
      if (onError) onError("Network error loading file");
    };
    xhr.send();
  };

  // Convert to base64
  BrowserPrint.Device.prototype.convertAndSendFile = function(url, onSuccess, onError, options) {
    var self = this;
    options = options || {};

    var xhr = new XMLHttpRequest();
    xhr.open("GET", url, true);
    xhr.responseType = "blob";

    xhr.onload = function() {
      if (xhr.status === 200) {
        var reader = new FileReader();
        reader.onloadend = function() {
          var base64data = reader.result.split(',')[1];

          var zpl = "^XA^FO0,0^IMR:" + (options.name || "IMAGE.PNG") + "^FS^XZ";

          self.send("~DY" + (options.name || "IMAGE.PNG") + ",B,B," + base64data, function() {
            self.send(zpl, onSuccess, onError);
          }, onError);
        };
        reader.readAsDataURL(xhr.response);
      } else {
        if (onError) onError("Failed to load image");
      }
    };

    xhr.onerror = function() {
      if (onError) onError("Network error loading image");
    };

    xhr.send();
  };

  // Expose BrowserPrint globally
  window.BrowserPrint = BrowserPrint;

  // Console log for debugging
  console.log("Zebra Browser Print SDK v" + BrowserPrint.ApplicationConfiguration.application.version + " loaded");
  console.log("Browser Print URL: " + getBrowserPrintUrl());

})();
